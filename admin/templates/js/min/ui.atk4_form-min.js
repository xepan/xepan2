jQuery.widget("ui.atk4_form",{form:void 0,id:void 0,submitted:void 0,base_url:void 0,loading:!1,show_loader:!0,plain_submit:!1,template:{},_getChanged:function(){return this.form.hasClass("form_changed")},_setChanged:function(e){return this.element.is(".ignore_changes")?void this.form.removeClass("form_changed"):void(e?this.form.addClass("form_changed"):this.form.removeClass("form_changed"))},_create:function(){var e=this;this.id=this.element.attr("id"),this.form=this.element,this.form.is("form")||(this.form=this.form.find("form"),this.element.bind("submit",function(r){r.preventDefault(),e.submitForm()})),console.log("created with url=",this.form.attr("action")),this.form.prepend('<input name="ajax_submit" id="ajax_submit" value="1" type="hidden"/>'),this.form.addClass("atk4_form"),this.element.addClass("atk4_form_widget"),this.form.find("input").bind("keypress",function(r){return $(this).is(".ui-autocomplete-input")?!0:13==r.keyCode?($(this).trigger("change"),e.submitForm(),!1):void 0}),this.form.find(":input").each(function(){"checkbox"==$(this).attr("type")?$(this).attr("data-initvalue",$(this).attr("checked")):$(this).attr("data-initvalue",$(this).val())}).bind("change",function(r){return $(this).attr("data-initvalue")==$(this).val()?void r.preventDefault():($(this).attr("data-initvalue",$(this).val()),void e._setChanged(!0))}),this.form.find("input[type=radio]").click(function(){e._setChanged(!0)}).change(function(){e._setChanged(!0)}),this.template.field_error=this.element.find(".field-error-template").remove(),this.template.field_error.length||console.log("Warning: form template does not have form-error-template class"),this.form.submit(function(r){return e.plain_submit?(r.stopPropagation(),void(e.plain_submit=!1)):(r.stopPropagation(),r.preventDefault(),void e.submitForm())}),this.base_url=window.location.href.substr(0,window.location.href.indexOf("#")),this.base_url||(this.base_url=window.location.href),this.options.base_url&&(this.base_url=this.options.base_url)},submitPlain:function(){this.plain_submit=!0,this.form.trigger("submit")},setFieldValue:function(e,r){var t=$("#"+this.id+"_"+e);if(!t.length)return void console.log("Unable to find field ",e," and fill in ",r);if(t.hasClass("field_reference")){var i=t.find("option[value="+r+"]");if(i.length)return void t.val(r).change().trigger("change_ref");var o=this;return void this.reloadField(e,null,function(){var t=$("#"+o.id+"_"+e),i=t.find("option[value="+r+"]");i.length?t.val(r).change().trigger("change_ref"):console.log("even after field reload, couldnt select ",r," for ",e)})}t.val(r).change()},reloadField:function(e,r,t,i,o){var a=$("#"+this.id+' [data-shortname="'+e+'"]').first().attr("id");r||(r=this.form.attr("action")),o&&$.each(o,function(e,t){r=$.atk4.addArgument(r,e+"="+encodeURIComponent(t))}),r=$.atk4.addArgument(r,this.id+"_cut_field",a);var n=$("#"+a);console.log("Field found: ",a,"->",n),i||n.trigger("reload_field");var s=n.closest(".atk-form-field");n=s;var l=this._getChanged();this._setChanged(!1),n.atk4_load(r,t),this._setChanged(l)},fieldError:function(e,r){if(this.options.error_handler)return this.options.error_handler(e,r);var t="string"==typeof e?$('[data-shortname="'+e+'"]',"#"+this.id):e;if(t.length||(t=this.form.find('[name="'+e+'"]')),!t.length)return void alert("Field not found: "+e+", error is: "+r);r&&"0"!=r||(r="must be specified properly"),t.focus(),t.closest("form").find(".field_error").remove();var i=t.closest(".field");i.addClass("error").addClass("has-error");var o=i.find(".atk-form-field");o.length||(o=i);var a=i.find(".error");if(a.remove(),!this.template.field_error.length)return void $.univ().errorMessage(r);var n=this.template.field_error.clone();n.find(".field-error-text").add(n.filter(".field-error-text")).text(r),n.appendTo(o).fadeIn(),this.form.addClass("form_has_error");var s=this;t.on("input paste change",function(e){t.trigger("change.errorhide")}),t.on("propertychange",function(e){"value"==e.originalEvent.propertyName&&t.trigger("change.errorhide")}),t.bind("change.errorhide",function(e){var r=$(this);r.unbind("change.errorhide"),s.form.removeClass("form_has_error"),i.removeClass("error"),o.closest(".has-error").removeClass("has-error"),n.fadeOut(function(){n.remove()})})},clearError:function(e){e=e?e.closest(".has-error"):this.form.find(".has-error"),e.find(".atk-form-error").remove(),e.removeClass("has-error")},submitForm:function(btn){var params={},form=this;if(form.loading)return $.univ().loadingInProgress(),!1;this.form.trigger("beforesubmit");var richtext=form.element.find(".atk4_richtext");if(richtext.length&&richtext.atk4_richtext("changeHTML"),params=form.element.find(":input").serializeArray(),btn)for(var el in params)if("ajax_submit"==params[el].name){params[el].value=btn;break}var properties={type:"POST",url:form.form.attr("action")};form.loading=!0,form.show_loader&&form.element.atk4_loader().atk4_loader("showLoader"),form.element.find(":input:enabled").attr("disabled",!0).attr("reenable",!0),form.element.find(".atk-effect-danger").removeClass("atk-effect-danger"),$.atk4.get(properties,params,function(res){var c=form._getChanged();if(form._setChanged(!1),$.atk4._checkSession(res)){try{eval(res)}catch(e){w=window.open(null,null,"height=400,width=700,location=no,menubar=no,scrollbars=yes,status=no,titlebar=no,toolbar=no"),w?(w.document.write("<h5>Error in AJAX response: "+e+"</h5>"),w.document.write(res),w.document.write('<center><input type=button onclick="window.close()" value="Close"></center>')):alert("Error in AJAX response: "+e+"\n"+res)}form._setChanged(c)}},function(){form.loading=!1,form.show_loader&&form.element.atk4_loader().atk4_loader("hideLoader"),form.element.find(":input[reenable]").removeAttr("disabled").removeAttr("reenable")})}});