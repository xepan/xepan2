# wget https://raw.githubusercontent.com/xepan/xepan2/master/serversetup -O xepan-install.sh && chmod +x xepan-install.sh && ./xepan-install.sh

echo "======== XEPAN IS ASKING ============"
echo What is mysql password you want to set
read mysqlpassword

echo "======== XEPAN IS ASKING ============"
echo Input xepan installation database name
read xepan_db_name

echo "======== XEPAN IS ASKING ============"
echo Which Epan version you want to install like 0.92
read xepan_version

echo "======== XEPAN IS ASKING ============"
echo Epan Host or IP for crontab
read xepan_host

apt-get upgrade
apt-get update
sudo dpkg-reconfigure tzdata
sudo apt-get install software-properties-common
sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xF1656F24C74CD1D8
sudo apt-get update && sudo apt-get install -y mariadb-server mariadb-client
service mysql start
#mysql_secure_installation
sed -i 's/bind-address/#bind-address/g' /etc/mysql/mariadb.conf.d/50-server.cnf

mysql -uroot -p$mysqlpassword -e "GRANT ALL ON *.* to root@'%' IDENTIFIED BY '$mysqlpassword';GRANT ALL ON *.* to root@'localhost' IDENTIFIED BY '$mysqlpassword';"
service mysql restart
mysql -uroot -p$mysqlpassword -e "create database $xepan_db_name;"

apt-get install -y apache2

sudo apt-get install -y php7.1 libapache2-mod-php7.1 php7.1-cli php7.1-common php7.1-mbstring php7.1-gd php7.1-intl php7.1-xml php7.1-mysql php7.1-mcrypt php7.1-zip php7.1-curl php7.1-imap
apt-get install -y unzip 

curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

cd /var/www/html
rm index.html


# Inpremises installation of ERP
git init
git remote add origin https://github.com/xepan/xepan2.git
git branch -f master HEAD && git checkout master
git pull origin master

composer install


# Open Source Version
#wget http://epan.in/xepan2-$xepan_version.zip
#unzip xepan2-$xepan_version.zip

### === init git for all required ===
cd /var/www/html/vendor/xepan/accounts
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/atk4
git branch -f master HEAD && git checkout 4.3
git pull origin 4.3

cd /var/www/html/vendor/xepan/base
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/blog
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/cms
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/commerce
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/communiciation
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/crm
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/hr
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/listing
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/marketing
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/omnipay-instalmojo
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/production
git branch -f master HEAD && git checkout master
git pull origin master

cd /var/www/html/vendor/xepan/projects
git branch -f master HEAD && git checkout master
git pull origin master

rm -rf /var/www/html/vendor/xepan/epanservices

cd /var/www/html
chown -R www-data:www-data .

# php settings
sed -i 's/display_errors = Off/display_errors = On/g' /etc/php/7.1/apache2/php.ini
sed -i 's/post_max_size = 8M/post_max_size = 20M/g' /etc/php/7.1/apache2/php.ini
sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 20M/g' /etc/php/7.1/apache2/php.ini

# change ssh port
sed -i 's/#Port 22/Port 2230/g' /etc/ssh/sshd_config
service sshd restart


service apache2 restart

# wsserver run
cd wsserver
nohup php index.php >/dev/null 2>&1 &

# setup cronjob
cat <(crontab -l) <(echo "* * * * * wget -O /dev/null -o /dev/null \"http://$xepan_host/?page=xepan_base_cron&cut_page=1\"") | crontab -

cd ..

echo "======== DONE ============"

#echo "run http://{serverip}/install and follow setup"



